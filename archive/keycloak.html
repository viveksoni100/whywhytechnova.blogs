<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Securing Spring Boot Microservices with Keycloak (Identity and Access management tool)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
    <link rel="stylesheet" href="./style.css">

    <style type="text/css">
        .code {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-left: 3px solid #f36d33;
            color: #666;
            page-break-inside: avoid;
            font-family: monospace;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 1.6em;
            max-width: 100%;
            overflow: auto;
            padding: 1em 1.5em;
            display: block;
            word-wrap: break-word;
        }
    </style>

</head>
<body>
<!-- partial:index.partial.html -->
<main>
    <div class="triangle"></div>
    <div class="triangle-2"></div>
    <div class="triangle-3"></div>
    <div class="container">

        <article>
            <h1>Securing Spring Boot Microservices with Keycloak (Identity and Access management tool)</h1>
            <div class="metadata">
                <span class="author">by Vivek Soni üòä </span>
                <span class="date">06 August 2022</span>
            </div>

            <p class="highlightme">What is Keycloak</p>

            <p>It is a tool for ‚ÄúIdentity and Access Management‚Äù, Keycloak is an open-source tool currently licensed
                with Apache License 2.0. It is also an upstream project for Red Hat SSO, so if you are looking for
                something more enterprise-centered, you can check it. </p>

            <p class="highlightme">Keycloak Features</b></p>
            <ol>
                <li><p><b style="font-weight: bold">‚óâ Multiple Protocols Support :</b> As for now Keycloak supports
                    three different protocols, namely - OpenID Connect, OAuth 2.0 and SAML 2.0.</p></li>
                <li><p><b style="font-weight: bold">‚óâ SSO :</b> Keycloak has full support for Single Sign-On and Single
                    Sign-Out.</p></li>
                <li><p><b style="font-weight: bold">‚óâ Admin Console :</b> Keycloak offers web-based GUI where you can
                    ‚Äúclick out‚Äù all configurations required by your instance to work as you desire.</p></li>
                <li><p><b style="font-weight: bold">‚óâ User Identity and Accesses :</b> Keycloak can be used as a
                    standalone user identity and access manager by allowing us to create users database with custom
                    roles and groups. This information can be further used to authenticate users within our application
                    and secure parts of it based on pre-defined roles.</p></li>
                <li><p><b style="font-weight: bold">‚óâ Social Identity Providers :</b> Additionally, Keycloak allows us
                    to use Social Identity Providers. It has built-in support Google, Twitter, Facebook, Stack Overflow
                    but, in the end, you have to configure all of them manually from admin panel. The full list of
                    supported social identity providers and their configuration manual can be found in Keycloak
                    documentation.</p></li>
                <center><img width="800" height="450"
                             src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/features.png"
                             class="responsive"></center>
                <br/><br/>
            </ol>
            <br>

            <p class="highlightme">Distributions of Keycloak</b></p>
            <ol>
                <li><p><b style="font-weight: bold">‚óâ Server :</b> Standalone application is downloadable from Keycloak
                    page in form of a tar or zip archive with all scripts, docs, and assets needed to work normally. As
                    for now, there are two main versions of this distribution: one is powered by WildFly server while
                    the other is powered by Quarkus. It is now in preview stage so some unexpected error may occur.</p>
                </li>
                <li><p><b style="font-weight: bold">‚óâ Docker Image :</b> Distribution appropriate for Docker, Podman,
                    Kubernetes, and OpenShift. There are two official docker images for Keycloak: one is held in Quay
                    Container Registry - quay.io/keycloak/keycloak, the second one is held in Docker Hub -
                    jboss/keycloak. You can download both of them with a simple docker pull command.</p></li>
                <li><p><b style="font-weight: bold">‚óâ Operator :</b> Distribution for Kubernetes and OpenShift based on
                    Operator SDK.</p></li>
            </ol>
            <br>


            <p class="highlightme">Hands On!</p>

            <p><b style="font-weight: bold;">1. Download Keyclock server <a href="https://www.keycloak.org/downloads">https://www.keycloak.org/downloads</a></b>
            </p>
            <center><img width="800" height="450"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/1.png"
                         class="responsive"></center>
            <br/><br/>
            <p><b style="font-weight: bold;">Note : </b>for windows download ZIP package</p>

            <p><b style="font-weight: bold;">2. Start Keyclock server</b></p>
            <p>unzip the package and hit the following command : sh bin/kc.sh start-dev</p>
            <center><img width="800" height="450"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/2.png"
                         class="responsive"></center>
            <br/><br/>
            <center><img width="800" height="450"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/3.png"
                         class="responsive"></center>
            <br/><br/>

            <p><b style="font-weight: bold;">3. Create Admin user</b></p>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/4.png"
                         class="responsive"></center>
            <br/><br/>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/5.png"
                         class="responsive"></center>
            <br/><br/>

            <p><b style="font-weight: bold;">4. go to Administration console and login with created user</b></p>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/6.png"
                         class="responsive"></center>
            <br/><br/>

            <p><b style="font-weight: bold;">5. create a realm (a component that holds user, role and role based
                authentications)</b></p>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/7.png"
                         class="responsive"></center>
            <br/><br/>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/8.png"
                         class="responsive"></center>
            <br/><br/>

            <p><b style="font-weight: bold;">6. create a client (a component that we use in our springboot app to
                communicate)</b></p>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/9.png"
                         class="responsive"></center>
            <br/><br/>

            <p><b style="font-weight: bold;">7. create a role</b></p>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/10.png"
                         class="responsive"></center>
            <br/><br/>

            <p><b style="font-weight: bold;">8. create a user and set username and password using credential tab</b></p>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/11.png"
                         class="responsive"></center>
            <br/><br/>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/12.png"
                         class="responsive"></center>
            <br/><br/>

            <p><b style="font-weight: bold;">9. map user and roles</b></p>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/13.png"
                         class="responsive"></center>
            <br/><br/>

            <p><b style="font-weight: bold;">10. add keycloak dependencies</b></p>
            <pre class="code">
            &lt;dependency&gt;
                &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
                &lt;artifactId&gt;keycloak-spring-boot-starter&lt;/artifactId&gt;
            &lt;/dependency&gt;
            </pre>
            <pre class="code">
            &lt;dependencyManagement&gt;
              &lt;dependencies&gt;
                &lt;dependency&gt;
                  &lt;groupId>org.keycloak.bom&lt;/groupId&gt;
                  &lt;artifactId>keycloak-adapter-bom&lt;/artifactId&gt;
                  &lt;version>19.0.0&lt;/version&gt;
                  &lt;type>pom&lt;/type&gt;
                  &lt;scope>import&lt;/scope&gt;
                &lt;/dependency&gt;
              &lt;/dependencies&gt;
            &lt;/dependencyManagement&gt;
            </pre>

            <p><b style="font-weight: bold;">11. add properties</b></p>
            <pre class="code">
                keycloak:
                  realm: demo-realm
                  auth-server-url: http://localhost:8080/auth
                  resource: keycloak-demo #client-id
                  public-client: true
                  bearer-only: true
            </pre>

            <p><b style="font-weight: bold;">12. create configuration class</b></p>
            <pre class="code">
                package com.javatechie.keycloak.config;

                import org.keycloak.adapters.springboot.KeycloakSpringBootConfigResolver;
                import org.keycloak.adapters.springsecurity.KeycloakConfiguration;
                import org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider;
                import org.keycloak.adapters.springsecurity.config.KeycloakWebSecurityConfigurerAdapter;
                import org.springframework.beans.factory.annotation.Autowired;
                import org.springframework.context.annotation.Bean;
                import org.springframework.context.annotation.Import;
                import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
                import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
                import org.springframework.security.config.annotation.web.builders.HttpSecurity;
                import org.springframework.security.core.authority.mapping.SimpleAuthorityMapper;
                import org.springframework.security.core.session.SessionRegistryImpl;
                import org.springframework.security.web.authentication.session.RegisterSessionAuthenticationStrategy;
                import org.springframework.security.web.authentication.session.SessionAuthenticationStrategy;

                @KeycloakConfiguration
                @EnableGlobalMethodSecurity(jsr250Enabled = true) //jsr250Enabled will allow us to write @RolesAllowed()
                @Import(KeycloakSpringBootConfigResolver.class)
                public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter {
                    /**
                     * Registers the KeycloakAuthenticationProvider with the authentication manager.
                     */
                    @Autowired
                    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
                        KeycloakAuthenticationProvider authenticationProvider = new KeycloakAuthenticationProvider();
                        authenticationProvider.setGrantedAuthoritiesMapper(new SimpleAuthorityMapper());
                        auth.authenticationProvider(authenticationProvider);
                    }

                    /**
                     * Defines the session authentication strategy.
                     */
                    @Bean
                    @Override
                    protected SessionAuthenticationStrategy sessionAuthenticationStrategy() {
                        return new RegisterSessionAuthenticationStrategy(new SessionRegistryImpl());
                    }

                    @Override
                    protected void configure(HttpSecurity http) throws Exception {
                        super.configure(http);
                        http
                                .authorizeRequests()
                                .anyRequest().permitAll();
                    }
                }
            </pre>

            <p><b style="font-weight: bold;">13. configuring role in our code</b></p>

            <pre class="code">
            package com.javatechie.keycloak;

            import com.javatechie.keycloak.entity.Employee;
            import com.javatechie.keycloak.service.EmployeeService;
            import org.springframework.beans.factory.annotation.Autowired;
            import org.springframework.boot.SpringApplication;
            import org.springframework.boot.autoconfigure.SpringBootApplication;
            import org.springframework.http.ResponseEntity;
            import org.springframework.web.bind.annotation.GetMapping;
            import org.springframework.web.bind.annotation.PathVariable;
            import org.springframework.web.bind.annotation.RequestMapping;
            import org.springframework.web.bind.annotation.RestController;

            import javax.annotation.security.RolesAllowed;
            import java.util.List;

            @SpringBootApplication
            @RestController
            @RequestMapping("/employees")
            public class SpringBootKeycloakExampleApplication {

                @Autowired
                private EmployeeService service;

                //this method can be accessed by user whose role is user
                @GetMapping("/{employeeId}")
                @RolesAllowed("user")   // only user role can allow this method
                public ResponseEntity&lt;Employee&gt; getEmployee(@PathVariable int employeeId) {
                    return ResponseEntity.ok(service.getEmployee(employeeId));
                }

                //this method can be accessed by user whose role is admin
                @GetMapping
                @RolesAllowed("admin") // only admin role can allow this method
                public ResponseEntity&lt;List&lt;Employee&gt;&gt; findALlEmployees() {
                    return ResponseEntity.ok(service.getAllEmployees());
                }

                public static void main(String[] args) {
                    SpringApplication.run(SpringBootKeycloakExampleApplication.class, args);
                }

            }

            </pre>

            <p><b style="font-weight: bold;">14. testing our code using postman with following parameters</b></p>
            <pre>
                Note - in postman's authorization type select OAuth 2.0
                Access Token Url : http://localhost:8080/auth/realms/demo-realm/protocol/openid-connect/token
                Client ID : keycloak-demo
                Scope : openid
                Grant Type : Password Credentials
                Username : &lt;username&gt;
                Password : &lt;password&gt;
                Access token : &lt;access token&gt;
            </pre>

            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/14.png"
                         class="responsive"></center>
            <br/><br/>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/15.png"
                         class="responsive"></center>
            <br/><br/>
            <center><img width="25%" height="25%"
                         src="https://raw.githubusercontent.com/viveksoni100/images.blogs/master/keycloak/16.png"
                         class="responsive"></center>
            <br/><br/>

            <hr>
            <p style="float: right;">Source : <a href="https://www.keycloak.org/">https://www.keycloak.org/</a></p>
            <p style="float: right;">source code : <a href="https://github.com/viveksoni100/keycloak_learning">https://github.com/viveksoni100/keycloak_learning</a></p>

        </article>
    </div>
</main>
<!-- partial -->

</body>
</html>
